version: "3.3"
services:

  postfix:
    image: "127.0.0.1:5000/postfix"
    build: ../postfix
    depends_on:
      - dovecot
      - ldap
    configs:
      - source: ssl_ca_cert
        target: /etc/ssl/postfix/ca.crt
    volumes:
      - type: volume
        source: postfix
        target: /data
    environment:
      postfix_fqdn: mail.fakedomain.test
      postfix_ldap_password: password
      postfix_ldap_tls_ca_cert_file: /etc/ssl/postfix/ca.crt

  dovecot:
    image: "127.0.0.1:5000/dovecot"
    build: ../dovecot
    depends_on:
      - ldap
      - solr
      - tika
    ports:
      - "143:143"
    configs:
      - source: ssl_ca_cert
        target: /etc/ssl/dovecot/ca.crt
      - source: dovecot_ssl_cert
        target: /etc/ssl/dovecot/server.crt
    secrets:
      - source: dovecot_ssl_key
        target: /etc/ssl/dovecot/server.key
        mode: 0400
    volumes:
      - type: volume
        source: dovecot
        target: /data
    environment:
      dovecot_ldap_password: password
      dovecot_ssl_dh_parameters_length: "1024"
      dovecot_ssl_ca_cert_file: /etc/ssl/dovecot/ca.crt
      dovecot_mail_replica: replica
      dovecot_doveadm_password: password

  replica:
    image: "127.0.0.1:5000/dovecot"
    depends_on:
      - ldap
      - solr
      - tika
    configs:
      - source: ssl_ca_cert
        target: /etc/ssl/dovecot/ca.crt
      - source: replica_ssl_cert
        target: /etc/ssl/dovecot/server.crt
    secrets:
      - source: replica_ssl_key
        target: /etc/ssl/dovecot/server.key
        mode: 0400
    volumes:
      - type: volume
        source: replica
        target: /data
    environment:
      dovecot_ldap_password: password
      dovecot_ssl_dh_parameters_length: "1024"
      dovecot_ssl_ca_cert_file: /etc/ssl/dovecot/ca.crt
      dovecot_mail_replica: dovecot
      dovecot_doveadm_password: password

  solr:
    image: "127.0.0.1:5000/solr-dovecot"
    build: ../solr

  tika:
    image: logicalspark/docker-tikaserver

  ldap:
    image: marklee77/fusiondirectory
    ports:
      - "80:80"
    configs:
      - source: ssl_ca_cert
        target: /etc/ssl/slapd/ca.crt
      - source: ldap_ssl_cert
        target: /etc/ssl/slapd/server.crt
      - source: mailserver_dbinit
        target: /etc/ldap/dbinit.d/20-mailserver
        mode: 0555
    secrets:
      - source: ldap_ssl_key
        target: /etc/ssl/slapd/server.key
        uid: '200'
        gid: '200'
        mode: 0440
    volumes:
      - type: volume
        source: ldap
        target: /data
    environment:
      fusiondirectory_admin_password: password
      slapd_admin_password: password

configs:
  ssl_ca_cert:
    file: ./ssl/certs/ca.cert.pem
  ldap_ssl_cert:
    file: ./ssl/certs/ldap.cert.pem
  dovecot_ssl_cert:
    file: ./ssl/certs/dovecot.cert.pem
  replica_ssl_cert:
    file: ./ssl/certs/replica.cert.pem
  mailserver_dbinit:
    file: ./slapd/mailserver-dbinit.sh

secrets:
  ldap_ssl_key:
    file: ./ssl/private/ldap.key.pem
  dovecot_ssl_key:
    file: ./ssl/private/dovecot.key.pem
  replica_ssl_key:
    file: ./ssl/private/replica.key.pem

volumes:
  postfix:
  dovecot:
  replica:
  ldap:
